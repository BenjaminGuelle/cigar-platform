<div class="mx-auto max-w-4xl space-y-6 md:space-y-8 px-4 md:px-6 py-6 md:py-8">
    <!-- Page Header with Back Button -->
    <div class="space-y-2">
      <div class="flex items-center gap-3">
        <a
          routerLink="/profile"
          class="p-2 -ml-2 rounded-lg hover:bg-smoke-800 transition-colors group"
          title="Retour au profil"
        >
          <i name="arrow-left" class="w-5 h-5 text-smoke-400 group-hover:text-gold-500 transition-colors"></i>
        </a>
        <h1 class="text-xl md:text-2xl font-semibold text-smoke-50">Paramètres</h1>
      </div>
      <p class="text-sm text-smoke-400">Gérez votre profil et vos préférences</p>
    </div>

    <!-- Profil Section -->
    <div class="space-y-4">
      <h2 class="text-base md:text-lg font-medium text-smoke-50">Profil</h2>
      <!-- Avatar Upload -->
      <div class="mb-8">
        <ui-avatar-upload
          type="user"
          [user]="currentUser()"
          [loading]="userStore.uploadAvatar.loading()"
          size="md"
          (fileSelected)="onAvatarFileSelected($event)"
        />
      </div>

        <!-- Form -->
        <form [formGroup]="profileForm" (ngSubmit)="onUpdateProfile()" class="space-y-6 md:space-y-8">
          <ui-input
            inputId="displayName"
            type="text"
            label="Nom d'affichage"
            placeholder="Votre nom"
            [control]="profileForm.controls.displayName"
            [required]="true"
            autocomplete="name"
          />

          <ui-input
            inputId="username"
            type="text"
            label="Nom d'utilisateur"
            placeholder="votre_pseudo"
            prefix="@"
            hint="Uniquement minuscules, chiffres, points (.) et underscores (_)"
            [control]="profileForm.controls.username"
            [required]="true"
            [errorMessages]="usernameErrorMessages"
            autocomplete="username"
          />

          <!-- Bio -->
          <div>
            <label class="block text-sm font-medium text-smoke-100 mb-2">
              Bio <span class="text-smoke-500">(optionnel)</span>
            </label>
            <textarea
              formControlName="bio"
              rows="3"
              maxlength="500"
              class="w-full px-4 py-3 rounded-lg border-2 border-smoke-700 bg-smoke-850 text-smoke-100 placeholder-smoke-500 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 focus:outline-none transition-all duration-200 resize-none"
              placeholder="Décrivez-vous en quelques mots..."
            ></textarea>
            @if (profileForm.controls.bio.value) {
              <p class="mt-1.5 text-sm text-smoke-400">
                {{ (profileForm.controls.bio.value || '').length }}/500 caractères
              </p>
            }
            @if (profileForm.controls.bio.invalid && profileForm.controls.bio.touched) {
              <p class="mt-1.5 text-sm text-error-500">
                Maximum 500 caractères
              </p>
            }
          </div>

          <!-- Action Buttons (text fields only) -->
          <div class="flex justify-end gap-3 pt-4">
            @if (hasUnsavedChanges()) {
              <ui-button
                type="button"
                variant="ghost"
                size="md"
                [disabled]="userStore.updateProfile.loading()"
                (click)="onCancelChanges()"
              >
                Annuler
              </ui-button>
            }
            <ui-button
              type="submit"
              variant="outline"
              size="md"
              [loading]="userStore.updateProfile.loading()"
              [disabled]="!hasUnsavedChanges() || profileForm.invalid || userStore.updateProfile.loading()"
            >
              Enregistrer
            </ui-button>
          </div>
        </form>
    </div>

    <!-- Confidentialité Section (auto-save switches) -->
    <div class="space-y-4">
      <h2 class="text-base md:text-lg font-medium text-smoke-50">Confidentialité</h2>
      <div class="space-y-6 md:space-y-8">
        <ui-switch
          switchId="visibility-public"
          switchPosition="right"
          label="Profil public"
          description="Afficher mon nom et @username sur mon profil. Si désactivé, seul @username sera visible"
          [control]="visibilitySwitch"
        />

        <ui-switch
          switchId="share-evaluations"
          switchPosition="right"
          label="Partager mes dégustations publiquement"
          description="Rendre mes évaluations de cigares visibles sur mon profil public"
          [control]="shareEvaluationsSwitch"
        />
      </div>
    </div>

    <!-- Mon abonnement Section -->
    <div class="space-y-4">
      <h2 class="text-base md:text-lg font-medium text-smoke-50">Mon abonnement</h2>
      <div class="rounded-xl border border-smoke-700 bg-smoke-850 p-4 md:p-6">
        <!-- Plan Header -->
        <div class="flex items-start justify-between">
          <div class="flex items-center gap-3">
            <!-- Plan Badge -->
            @if (planService.isPremium()) {
              <div class="flex h-10 w-10 items-center justify-center rounded-full bg-gradient-to-br from-gold-500 to-gold-600">
                <i name="crown" class="w-5 h-5 text-smoke-900"></i>
              </div>
            } @else {
              <div class="flex h-10 w-10 items-center justify-center rounded-full bg-smoke-700">
                <i name="user" class="w-5 h-5 text-smoke-400"></i>
              </div>
            }
            <div>
              <p class="text-base font-medium text-smoke-50">{{ planService.planLabel() }}</p>
              @if (planService.isBetaTester()) {
                <p class="text-sm text-gold-500">Merci d'avoir rejoint la Beta !</p>
              } @else if (planService.isLifetime()) {
                <p class="text-sm text-gold-500">Accès permanent</p>
              } @else if (!planService.isPremium()) {
                <p class="text-sm text-smoke-400">Accès aux fonctionnalités de base</p>
              }
            </div>
          </div>

          <!-- Status Badge -->
          @if (planService.isPremium()) {
            <span class="rounded-full bg-gold-500/10 px-3 py-1 text-sm font-medium text-gold-500">
              Actif
            </span>
          } @else {
            <span class="rounded-full bg-smoke-700 px-3 py-1 text-sm font-medium text-smoke-400">
              Gratuit
            </span>
          }
        </div>

        <!-- Expiration Info (for expiring plans) -->
        @if (planService.isPremium() && planService.expiresAt()) {
          <div class="mt-4 pt-4 border-t border-smoke-700">
            @if (planService.isInGracePeriod()) {
              <!-- Grace Period Warning -->
              <div class="flex items-start gap-3 rounded-lg bg-warning-500/10 p-3">
                <i name="alert-circle" class="w-5 h-5 text-warning-500 mt-0.5"></i>
                <div>
                  <p class="text-sm font-medium text-warning-500">Votre abonnement a expiré</p>
                  <p class="text-sm text-smoke-400 mt-1">
                    Vous avez encore quelques jours d'accès. Renouvelez pour conserver vos avantages Premium.
                  </p>
                </div>
              </div>
            } @else if (planService.isExpiringSoon()) {
              <!-- Expiring Soon Warning -->
              <div class="flex items-start gap-3 rounded-lg bg-gold-500/10 p-3">
                <i name="calendar" class="w-5 h-5 text-gold-500 mt-0.5"></i>
                <div>
                  <p class="text-sm font-medium text-gold-500">Expire bientôt</p>
                  <p class="text-sm text-smoke-400 mt-1">
                    Votre accès Premium expire le {{ planService.formattedExpiresAt() }}
                    ({{ planService.daysRemaining() }} jours restants)
                  </p>
                </div>
              </div>
            } @else {
              <!-- Normal expiration display -->
              <div class="flex items-center justify-between">
                <p class="text-sm text-smoke-400">Valide jusqu'au</p>
                <p class="text-sm text-smoke-100">{{ planService.formattedExpiresAt() }}</p>
              </div>
              @if (planService.daysRemaining() !== null) {
                <div class="flex items-center justify-between mt-2">
                  <p class="text-sm text-smoke-400">Jours restants</p>
                  <p class="text-sm text-smoke-100">{{ planService.daysRemaining() }}</p>
                </div>
              }
            }
          </div>
        }

        <!-- Gift Reason (if applicable) -->
        @if (planService.giftReason()) {
          <div class="mt-4 pt-4 border-t border-smoke-700">
            <div class="flex items-center justify-between">
              <p class="text-sm text-smoke-400">Raison</p>
              <p class="text-sm text-smoke-100">{{ planService.giftReason() }}</p>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Compte Section -->
    <div class="space-y-4">
      <h2 class="text-base md:text-lg font-medium text-smoke-50">Compte</h2>
      <div class="space-y-6 md:space-y-8">
        <!-- Email -->
        <div class="flex items-center justify-between border-b border-smoke-800 pb-6">
          <div class="flex-1">
            <p class="label">Email</p>
            <p class="mt-1 text-smoke-50">{{ currentUser()?.email }}</p>
            @if (isOAuthUser()) {
              <p class="caption mt-1">
                Connecté via {{ providerLabel() }}
              </p>
            }
          </div>
          <span
            class="caption rounded-full px-3 py-1 font-medium"
            [class]="
              isOAuthUser()
                ? 'bg-blue-500/10 text-blue-400'
                : 'bg-smoke-800 text-smoke-400'
            "
          >
            {{ providerLabel() }}
          </span>
        </div>

        <!-- Logout -->
        <div class="flex justify-end pt-4">
          <ui-button
            type="button"
            variant="destructive"
            size="md"
            [loading]="logoutLoading()"
            [disabled]="logoutLoading()"
            (click)="onLogout()"
          >
            Se déconnecter
          </ui-button>
        </div>
      </div>
    </div>

    <!-- À propos Section -->
    <div class="space-y-4">
      <h2 class="text-base md:text-lg font-medium text-smoke-50">À propos</h2>
      <div class="space-y-2">
        <p class="body">Cigar & Club - Application de gestion de clubs de dégustation</p>
        <p class="caption">Version 1.0.0</p>
      </div>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <app-confirmation-modal
    [isOpen]="showLogoutConfirm()"
    [title]="'Se déconnecter'"
    [message]="'Êtes-vous sûr de vouloir vous déconnecter ?'"
    [confirmLabel]="'Se déconnecter'"
    [cancelLabel]="'Annuler'"
    [variant]="'warning'"
    [loading]="logoutLoading()"
    (confirm)="onConfirmLogout()"
    (cancel)="showLogoutConfirm.set(false)"
  />