<div class="mx-auto max-w-4xl space-y-6 md:space-y-8 px-4 md:px-6 py-6 md:py-8">
    <!-- Page Header -->
    <ui-page-header
      title="Paramètres"
      description="Gérez votre profil et vos préférences"
    />

    <!-- Public Profile Link & Share -->
    @if (currentUser()) {
      <div class="flex flex-col gap-2 -mt-2 mb-2">
        <div class="flex items-center gap-3">
          <a
            [routerLink]="['/user', '@' + currentUser()!.username]"
            class="group flex items-center gap-2"
          >
            <i
              name="eye"
              class="w-4 h-4 text-gold-500 group-hover:scale-110 transition-transform duration-200"
            ></i>
            <span class="text-sm font-medium text-gold-500 hover:text-gold-400 transition-colors">
              Voir mon profil public
            </span>
          </a>
          <button
            type="button"
            (click)="copyProfileLink()"
            class="group flex items-center gap-2 px-3 py-1.5 rounded-md bg-smoke-800 hover:bg-smoke-700 transition-colors"
          >
            <i
              name="book-copy"
              class="w-4 h-4 text-smoke-400 group-hover:text-gold-500 transition-colors"
            ></i>
            <span class="text-sm font-medium text-smoke-400 group-hover:text-gold-500 transition-colors">
              Partager mon profil
            </span>
          </button>
        </div>
        <p class="caption text-smoke-400">@{{ username() }}</p>
      </div>
    }

    <!-- Profil Section -->
    <ui-page-section title="Profil">
      <!-- Avatar Upload -->
      <div class="mb-8">
        <ui-avatar-upload
          type="user"
          [user]="currentUser()"
          [loading]="userStore.uploadAvatar.loading()"
          size="md"
          (fileSelected)="onAvatarFileSelected($event)"
        />
      </div>

        <!-- Form -->
        <form [formGroup]="profileForm" (ngSubmit)="onUpdateProfile()" class="space-y-6 md:space-y-8">
          <ui-input
            inputId="displayName"
            type="text"
            label="Nom d'affichage"
            placeholder="Votre nom"
            [control]="profileForm.controls.displayName"
            [required]="true"
            autocomplete="name"
          />

          <ui-input
            inputId="username"
            type="text"
            label="Nom d'utilisateur"
            placeholder="votre_pseudo"
            prefix="@"
            hint="Uniquement minuscules, chiffres, points (.) et underscores (_)"
            [control]="profileForm.controls.username"
            [required]="true"
            [errorMessages]="usernameErrorMessages"
            autocomplete="username"
          />

          <!-- Bio -->
          <div>
            <label class="block text-sm font-medium text-smoke-100 mb-2">
              Bio <span class="text-smoke-500">(optionnel)</span>
            </label>
            <textarea
              formControlName="bio"
              rows="3"
              maxlength="500"
              class="w-full px-4 py-3 rounded-lg border-2 border-smoke-700 bg-smoke-850 text-smoke-100 placeholder-smoke-500 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 focus:outline-none transition-all duration-200 resize-none"
              placeholder="Décrivez-vous en quelques mots..."
            ></textarea>
            @if (profileForm.controls.bio.value) {
              <p class="mt-1.5 text-sm text-smoke-400">
                {{ (profileForm.controls.bio.value || '').length }}/500 caractères
              </p>
            }
            @if (profileForm.controls.bio.invalid && profileForm.controls.bio.touched) {
              <p class="mt-1.5 text-sm text-error-500">
                Maximum 500 caractères
              </p>
            }
          </div>

          <!-- Action Buttons (text fields only) -->
          <div class="flex justify-end gap-3 pt-4">
            @if (hasUnsavedChanges()) {
              <ui-button
                type="button"
                variant="ghost"
                size="md"
                [disabled]="userStore.updateProfile.loading()"
                (click)="onCancelChanges()"
              >
                Annuler
              </ui-button>
            }
            <ui-button
              type="submit"
              variant="outline"
              size="md"
              [loading]="userStore.updateProfile.loading()"
              [disabled]="!hasUnsavedChanges() || profileForm.invalid || userStore.updateProfile.loading()"
            >
              Enregistrer
            </ui-button>
          </div>
        </form>
    </ui-page-section>

    <!-- Confidentialité Section (auto-save switches) -->
    <ui-page-section title="Confidentialité">
      <div class="space-y-6 md:space-y-8">
        <ui-switch
          switchId="visibility-public"
          switchPosition="right"
          label="Profil public"
          description="Afficher mon nom et @username sur mon profil. Si désactivé, seul @username sera visible"
          [control]="visibilitySwitch"
        />

        <ui-switch
          switchId="share-evaluations"
          switchPosition="right"
          label="Partager mes dégustations publiquement"
          description="Rendre mes évaluations de cigares visibles sur mon profil public"
          [control]="shareEvaluationsSwitch"
        />
      </div>
    </ui-page-section>

    <!-- Compte Section -->
    <ui-page-section title="Compte">
      <div class="space-y-6 md:space-y-8">
        <!-- Email -->
        <div class="flex items-center justify-between border-b border-smoke-800 pb-6">
          <div class="flex-1">
            <p class="label">Email</p>
            <p class="mt-1 text-smoke-50">{{ currentUser()?.email }}</p>
            @if (isOAuthUser()) {
              <p class="caption mt-1">
                Connecté via {{ providerLabel() }}
              </p>
            }
          </div>
          <span
            class="caption rounded-full px-3 py-1 font-medium"
            [class]="
              isOAuthUser()
                ? 'bg-blue-500/10 text-blue-400'
                : 'bg-smoke-800 text-smoke-400'
            "
          >
            {{ providerLabel() }}
          </span>
        </div>

        <!-- Logout -->
        <div class="flex justify-end pt-4">
          <ui-button
            type="button"
            variant="destructive"
            size="md"
            [loading]="logoutLoading()"
            [disabled]="logoutLoading()"
            (click)="onLogout()"
          >
            Se déconnecter
          </ui-button>
        </div>
      </div>
    </ui-page-section>

    <!-- À propos Section -->
    <ui-page-section title="À propos" [bordered]="false">
      <div class="space-y-2">
        <p class="body">Cigar & Club - Application de gestion de clubs de dégustation</p>
        <p class="caption">Version 1.0.0</p>
      </div>
    </ui-page-section>
  </div>

  <!-- Logout Confirmation Modal -->
  <app-confirmation-modal
    [isOpen]="showLogoutConfirm()"
    [title]="'Se déconnecter'"
    [message]="'Êtes-vous sûr de vouloir vous déconnecter ?'"
    [confirmLabel]="'Se déconnecter'"
    [cancelLabel]="'Annuler'"
    [variant]="'warning'"
    [loading]="logoutLoading()"
    (confirm)="onConfirmLogout()"
    (cancel)="showLogoutConfirm.set(false)"
  />