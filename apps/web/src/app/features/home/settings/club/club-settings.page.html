<div class="mx-auto max-w-4xl space-y-6 md:space-y-8 px-4 md:px-6 py-6 md:py-8">
  <!-- Guard: Check access permissions -->
  @if (!contextStore.canAccessSettings()) {
    <div class="flex flex-col items-center justify-center py-16 text-center">
      <div class="rounded-full bg-smoke-800/50 p-4 mb-4">
        <lucide-icon
          [img]="LockKeyhole"
          [size]="48"
          class="text-smoke-400"
        />
      </div>
      <h3 class="text-lg font-semibold text-smoke-100 mb-2">
        Accès restreint
      </h3>
      <p class="text-sm text-smoke-400 max-w-sm">
        Vous n'avez pas accès aux paramètres dans ce contexte
      </p>
    </div>
  } @else if (loading()) {
    <!-- Loading State -->
    <div class="flex justify-center items-center py-16">
      <div class="animate-spin rounded-full h-12 w-12 border-2 border-gold-500 border-t-transparent"></div>
    </div>
  } @else {
    <!-- Settings Form -->
    <div class="space-y-8">
      <ui-page-header
        title="Paramètres du club"
        [description]="'Gérez les paramètres de ' + (club()?.name || 'votre club')"
      />

      <!-- Public Club Page Link & Share -->
      @if (club()) {
        <div class="flex flex-col gap-2 -mt-2 mb-2">
          <div class="flex items-center gap-3">
            <a
              [routerLink]="['/club', club()!.id]"
              class="group flex items-center gap-2"
            >
              <i
                name="eye"
                class="w-4 h-4 text-gold-500 group-hover:scale-110 transition-transform duration-200"
              ></i>
              <span class="text-sm font-medium text-gold-500 hover:text-gold-400 transition-colors">
                Voir la page du club
              </span>
            </a>
            <button
              type="button"
              (click)="copyClubLink()"
              class="group flex items-center gap-2 px-3 py-1.5 rounded-md bg-smoke-800 hover:bg-smoke-700 transition-colors"
            >
              <i
                name="book-copy"
                class="w-4 h-4 text-smoke-400 group-hover:text-gold-500 transition-colors"
              ></i>
              <span class="text-sm font-medium text-smoke-400 group-hover:text-gold-500 transition-colors">
                Partager le club
              </span>
            </button>
          </div>
          <p class="caption text-smoke-400">#{{ clubSlug() }}</p>
        </div>
      }

      <!-- Avatar Section (Admin & Owner only) -->
      @if (contextStore.canManageClub()) {
        <ui-page-section title="Avatar du club">
          <ui-avatar-upload
            type="club"
            [imageUrl]="club()?.imageUrl ?? null"
            [name]="club()?.name ?? ''"
            [loading]="clubStore.uploadClubAvatar.loading()"
            size="md"
            (fileSelected)="onAvatarFileSelected($event)"
          />
        </ui-page-section>
      }

      <form [formGroup]="clubForm" (ngSubmit)="onUpdateClub()" class="space-y-8">
        <!-- Club Information Section (Admin & Owner only) -->
        @if (contextStore.canManageClub()) {
          <ui-page-section title="Informations du club">
            <div class="space-y-6 md:space-y-8">
              <!-- Name (Owner only) -->
              <ui-input
                inputId="club-name"
                type="text"
                label="Nom du club"
                placeholder="Ex: Les Aficionados du Cigare"
                [control]="clubForm.controls.name"
                [required]="true"
                autocomplete="off"
              />

              <!-- Description (Admin & Owner) -->
              <div>
                <label class="block text-sm font-medium text-smoke-100 mb-2">
                  Description
                </label>
                <textarea
                  formControlName="description"
                  rows="4"
                  class="w-full px-4 py-3 rounded-lg border-2 border-smoke-700 bg-smoke-850 text-smoke-100 placeholder-smoke-500 focus:border-gold-500 focus:ring-2 focus:ring-gold-500/20 focus:outline-none transition-all duration-200 resize-none disabled:opacity-50 disabled:cursor-not-allowed"
                  placeholder="Décrivez votre club..."
                ></textarea>
                @if (clubForm.controls.description.invalid && clubForm.controls.description.touched) {
                  <p class="mt-1.5 text-sm text-error-500">
                    Maximum 500 caractères
                  </p>
                }
              </div>
            </div>
          </ui-page-section>
        }

        <!-- Privacy & Access Section (Owner only) -->
        @if (contextStore.canEditCriticalSettings()) {
          <ui-page-section title="Confidentialité & Accès">
            <div class="space-y-6 md:space-y-8">
              <!-- Visibility -->
              <ui-select
                selectId="visibility"
                label="Visibilité du club"
                hint="Les clubs publics sont visibles dans /explore. Les clubs privés ne sont accessibles que par invitation."
                [control]="clubForm.controls.visibility"
                [options]="visibilityOptions"
                [required]="true"
              />

            <!-- Public Directory (only for PUBLIC clubs) -->
            @if (clubForm.controls.visibility.value === 'PUBLIC') {
              <ui-checkbox
                checkboxId="public-directory"
                label="Répertoire public"
                description="Afficher ce club dans le répertoire public"
                [control]="clubForm.controls.isPublicDirectory"
              />

              <!-- Auto-approve members -->
              <ui-checkbox
                checkboxId="auto-approve"
                label="Approbation automatique"
                description="Accepter automatiquement les demandes d'adhésion"
                [control]="clubForm.controls.autoApproveMembers"
              />
            }

            <!-- Allow member invites -->
            <ui-checkbox
              checkboxId="member-invites"
              label="Invitations par les membres"
              description="Permettre aux membres d'inviter d'autres personnes"
              [control]="clubForm.controls.allowMemberInvites"
            />

            <!-- Max members -->
            <ui-input
              inputId="max-members"
              type="number"
              label="Nombre maximum de membres (optionnel)"
              placeholder="Illimité"
              hint="Laisser vide pour un nombre illimité de membres"
              [control]="clubForm.controls.maxMembers"
              [minlength]="1"
            />
          </div>
        </ui-page-section>
        }

        <!-- Action Buttons (Admin & Owner only) -->
        @if (contextStore.canManageClub()) {
          <div class="flex justify-end gap-3 pt-4">
            @if (hasUnsavedChanges()) {
              <ui-button
                type="button"
                variant="ghost"
                size="md"
                [disabled]="updateClubLoading()"
                (click)="onCancelChanges()"
              >
                Annuler
              </ui-button>
            }
            <ui-button
              type="submit"
              variant="outline"
              size="md"
              [loading]="updateClubLoading()"
              [disabled]="!hasUnsavedChanges() || clubForm.invalid || updateClubLoading()"
            >
              Enregistrer
            </ui-button>
          </div>
        }
      </form>

      <!-- Danger Zone -->
      <ui-page-section title="Zone de danger">
        <div class="space-y-4">
          <!-- Archive Club (Owner Only) -->
          @if (isOwner()) {
            <div class="rounded-lg border-2 border-error-500/30 bg-error-500/5 p-6">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <h3 class="text-base font-semibold text-smoke-100 mb-1">
                    Archiver le club
                  </h3>
                  <p class="text-sm text-smoke-400">
                    Le club ne sera plus accessible aux membres. Cette action est réversible.
                  </p>
                </div>
                <button
                  type="button"
                  (click)="onArchiveClub()"
                  class="shrink-0 px-4 py-2 bg-error-600 hover:bg-error-700 text-white font-medium rounded-lg transition-colors focus:ring-2 focus:ring-error-500/50 focus:outline-none"
                >
                  Archiver
                </button>
              </div>
            </div>
          }

          <!-- Leave Club (All roles, disabled for Owner) -->
          <div class="rounded-lg border-2 border-warning-500/30 bg-warning-500/5 p-6">
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <h3 class="text-base font-semibold text-smoke-100 mb-1">
                  Quitter le club
                </h3>
                <p class="text-sm text-smoke-400">
                  @if (isOwner()) {
                    Vous devez transférer la propriété à un autre membre avant de pouvoir quitter le club.
                  } @else {
                    Vous ne serez plus membre de ce club. Vous pourrez demander à rejoindre à nouveau.
                  }
                </p>
              </div>
              <button
                type="button"
                (click)="onLeaveClub()"
                [disabled]="leavingClub() || isOwner()"
                class="shrink-0 px-4 py-2 bg-warning-600 hover:bg-warning-700 text-white font-medium rounded-lg transition-colors focus:ring-2 focus:ring-warning-500/50 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed"
              >
                @if (leavingClub()) {
                  <span class="flex items-center gap-2">
                    <div class="animate-spin rounded-full h-4 w-4 border-2 border-white border-t-transparent"></div>
                    Chargement...
                  </span>
                } @else {
                  Quitter
                }
              </button>
            </div>
          </div>
        </div>
      </ui-page-section>
    </div>
  }
</div>

<!-- Archive Club Confirmation Modal -->
<app-confirmation-modal
  [isOpen]="showArchiveConfirm()"
  [title]="'Archiver le club'"
  [message]="'Êtes-vous sûr de vouloir archiver ' + (club()?.name || 'ce club') + ' ? Le club ne sera plus accessible aux membres. Cette action est réversible.'"
  [confirmLabel]="'Archiver'"
  [cancelLabel]="'Annuler'"
  [variant]="'destructive'"
  (confirm)="onConfirmArchiveClub()"
  (cancel)="showArchiveConfirm.set(false)"
/>

<!-- Leave Club Confirmation Modal -->
<app-confirmation-modal
  [isOpen]="showLeaveConfirm()"
  [title]="'Quitter le club'"
  [message]="'Êtes-vous sûr de vouloir quitter ' + (club()?.name || 'ce club') + ' ? Vous pourrez demander à rejoindre à nouveau.'"
  [confirmLabel]="'Quitter'"
  [cancelLabel]="'Annuler'"
  [variant]="'warning'"
  [loading]="leavingClub()"
  (confirm)="onConfirmLeaveClub()"
  (cancel)="showLeaveConfirm.set(false)"
/>
