<!-- Explore Page - Full Page Search Experience -->
<div class="flex flex-col min-h-screen">
  <!-- Fixed Search Header (pinned at top with safe-area) -->
  <div class="fixed top-0 left-0 right-0 z-20 bg-smoke-700 px-4 pb-3 pt-[max(0.5rem,env(safe-area-inset-top))] md:hidden">
    <!-- Search Input Row -->
    <div class="flex items-center gap-3">
      <div class="flex-1 transition-all duration-200 ease-out" (focusin)="handleFocus()">
        <ui-input
          #searchInput
          type="search"
          placeholder="Rechercher..."
          [control]="searchControl"
          [suffixIcon]="true"
        >
          <i slot="suffix-icon" uiIcon name="search" class="w-5 h-5 text-smoke-400"></i>
        </ui-input>
      </div>

      <!-- Cancel Button (visible when focused) -->
      <button
        type="button"
        class="text-sm text-gold-500 hover:text-gold-400 transition-all duration-200 ease-out whitespace-nowrap"
        [class.opacity-0]="isDiscoveryMode()"
        [class.opacity-100]="isSearchMode()"
        [class.pointer-events-none]="isDiscoveryMode()"
        [class.w-0]="isDiscoveryMode()"
        [class.w-auto]="isSearchMode()"
        [class.overflow-hidden]="isDiscoveryMode()"
        (click)="handleCancel()"
      >
        Annuler
      </button>
    </div>

    <!-- Search Hint -->
    <p class="text-xs text-smoke-400 mt-2">
      Découvrez cigares, marques et aficionados
    </p>
  </div>

  <!-- Desktop Search Header (sticky, below top tabs) -->
  <div class="hidden md:block sticky top-0 z-10 bg-smoke-700 pb-3">
    <!-- Search Input Row -->
    <div class="flex items-center gap-3">
      <div class="flex-1 transition-all duration-200 ease-out" (focusin)="handleFocus()">
        <ui-input
          type="search"
          placeholder="Rechercher..."
          [control]="searchControl"
          [suffixIcon]="true"
        >
          <i slot="suffix-icon" uiIcon name="search" class="w-5 h-5 text-smoke-400"></i>
        </ui-input>
      </div>

      <!-- Cancel Button (visible when focused) -->
      <button
        type="button"
        class="text-sm text-gold-500 hover:text-gold-400 transition-all duration-200 ease-out whitespace-nowrap"
        [class.opacity-0]="isDiscoveryMode()"
        [class.opacity-100]="isSearchMode()"
        [class.pointer-events-none]="isDiscoveryMode()"
        [class.w-0]="isDiscoveryMode()"
        [class.w-auto]="isSearchMode()"
        [class.overflow-hidden]="isDiscoveryMode()"
        (click)="handleCancel()"
      >
        Annuler
      </button>
    </div>

    <!-- Search Hint -->
    <p class="text-xs text-smoke-400 mt-2">
      Découvrez cigares, marques et aficionados
    </p>
  </div>

  <!-- Results Zone -->
  <div class="flex-1 relative">
    <!-- ============================================ -->
    <!-- DISCOVERY MODE - Shows when search is empty -->
    <!-- ============================================ -->
    <div
      class="absolute inset-x-0 bottom-0 top-[calc(6.5rem+env(safe-area-inset-top))] md:top-0 transition-opacity duration-200 ease-out will-change-[opacity] overflow-y-auto"
      [class.opacity-100]="isDiscoveryMode()"
      [class.opacity-0]="isSearchMode()"
      [class.z-10]="isDiscoveryMode()"
      [class.z-0]="isSearchMode()"
      [class.pointer-events-auto]="isDiscoveryMode()"
      [class.pointer-events-none]="isSearchMode()"
    >
      <!-- Discovery Content -->
      <div class="pt-2 px-4 md:px-0">
        <!-- Skeleton Loading State -->
        @if (discoveryLoading()) {
          <!-- Skeleton: Nouveaux cigares -->
          <section class="mb-6 animate-pulse">
            <div class="h-3 w-28 bg-smoke-600/30 rounded mb-3"></div>
            <div class="space-y-2.5">
              @for (i of [1, 2, 3]; track i) {
                <div class="flex items-baseline gap-2">
                  <div class="h-4 bg-smoke-600/20 rounded" [style.width.px]="100 + i * 20"></div>
                  <div class="h-3 w-16 bg-smoke-600/15 rounded"></div>
                </div>
              }
            </div>
          </section>

          <!-- Skeleton: Dernières dégustations -->
          <section class="mb-6 animate-pulse">
            <div class="h-3 w-36 bg-smoke-600/30 rounded mb-3"></div>
            <div class="space-y-3">
              @for (i of [1, 2, 3, 4, 5, 6]; track i) {
                <div>
                  <div class="h-4 bg-smoke-600/20 rounded mb-1" [style.width.%]="60 + (i % 3) * 10"></div>
                  <div class="flex items-center gap-1.5">
                    <div class="h-3 w-3 bg-smoke-600/15 rounded"></div>
                    <div class="h-3 w-6 bg-smoke-600/15 rounded"></div>
                    <div class="h-3 w-16 bg-smoke-600/15 rounded"></div>
                    <div class="h-3 w-6 bg-smoke-600/15 rounded"></div>
                  </div>
                </div>
              }
            </div>
          </section>
        }

        @if (!discoveryLoading()) {
          <!-- Section: Nouveaux cigares -->
          @if (recentCigars().length > 0) {
            <section class="mb-6">
              <h2 class="text-xs font-semibold text-smoke-500 uppercase tracking-wider mb-3">
                Nouveaux cigares
              </h2>
              <!-- Text-only list -->
              <div class="space-y-2.5">
                @for (cigar of recentCigars(); track cigar.id) {
                  <div
                    class="flex items-baseline gap-2 cursor-pointer group"
                    (click)="handleDiscoverCigarClick(cigar)"
                  >
                    <span class="text-sm text-smoke-200 group-hover:text-gold-500 transition-colors font-medium">{{ cigar.name }}</span>
                    <span class="text-smoke-600">·</span>
                    <span class="text-xs text-smoke-500">{{ cigar.brandName }}</span>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Section: Dernières dégustations -->
          @if (recentTastings().length > 0) {
            <section class="mb-6">
              <h2 class="text-xs font-semibold text-smoke-500 uppercase tracking-wider mb-3">
                Dernières dégustations
              </h2>
              <!-- Text-only feed -->
              <div class="space-y-3">
                @for (tasting of recentTastings(); track tasting.id) {
                  <div
                    class="cursor-pointer group"
                    (click)="handleDiscoverTastingClick(tasting)"
                  >
                    <!-- Line 1: Cigar name -->
                    <p class="text-sm text-smoke-200 group-hover:text-gold-500 transition-colors font-medium truncate">
                      {{ tasting.cigarName }}
                    </p>
                    <!-- Line 2: Rating + Username + Date -->
                    <div class="flex items-center gap-1.5 mt-0.5">
                      <i uiIcon name="star" class="w-3 h-3 text-gold-500"></i>
                      <span class="text-xs text-smoke-300">{{ tasting.rating }}</span>
                      <span class="text-smoke-600">·</span>
                      <span class="text-xs text-smoke-500">@{{ tasting.username }}</span>
                      <span class="text-smoke-600">·</span>
                      <span class="text-xs text-smoke-600">{{ formatRelativeTime(tasting.createdAt) }}</span>
                    </div>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Empty State -->
          @if (recentCigars().length === 0 && recentTastings().length === 0) {
            <div class="py-8 text-center">
              <p class="text-sm text-smoke-500">Aucun contenu à découvrir pour le moment</p>
            </div>
          }
        }
      </div>
    </div>

    <!-- ============================================ -->
    <!-- SEARCH MODE - Shows when user is typing -->
    <!-- ============================================ -->
    <div
      class="absolute inset-x-0 bottom-0 top-[calc(6.5rem+env(safe-area-inset-top))] md:top-0 transition-opacity duration-200 ease-out will-change-[opacity] overflow-y-auto"
      [class.opacity-100]="isSearchMode()"
      [class.opacity-0]="isDiscoveryMode()"
      [class.z-10]="isSearchMode()"
      [class.z-0]="isDiscoveryMode()"
      [class.pointer-events-auto]="isSearchMode()"
      [class.pointer-events-none]="isDiscoveryMode()"
    >
      <!-- Search Hints (shown when query is empty) -->
      @if (showSearchHints()) {
        <div class="px-4 md:px-0">
          <div class="space-y-3">
            <p class="text-sm text-smoke-500">
              <span class="text-gold-700 font-medium">@pseudo</span>
              <span class="text-smoke-500 mx-2">·</span>
              Rechercher un membre
            </p>
            <p class="text-sm text-smoke-500">
              <span class="text-gold-700 font-medium">#club</span>
              <span class="text-smoke-500 mx-2">·</span>
              Rechercher un club
            </p>
            <p class="text-sm text-smoke-500">
              <span class="text-smoke-400 font-medium">nom du cigare</span>
              <span class="text-smoke-500 mx-2">·</span>
              Rechercher un cigare ou une marque
            </p>
          </div>
        </div>
      }

      <!-- Skeleton Loading State -->
      @if (loading()) {
        <div class="pt-2 px-4 md:px-0 animate-pulse">
          <!-- Skeleton group -->
          <div class="mb-4">
            <div class="h-3 w-20 bg-smoke-600/30 rounded mb-3"></div>
            <div class="space-y-2">
              @for (i of [1, 2, 3]; track i) {
                <div class="flex items-center gap-3 py-2">
                  <div class="w-10 h-10 bg-smoke-600/20 rounded-lg"></div>
                  <div class="flex-1">
                    <div class="h-4 bg-smoke-600/20 rounded mb-1" [style.width.%]="50 + i * 10"></div>
                    <div class="h-3 w-24 bg-smoke-600/15 rounded"></div>
                  </div>
                </div>
              }
            </div>
          </div>
        </div>
      }

      <!-- Results (Grouped by Type) - Priority Order: Cigars/Brands -> Clubs -> Users -->
      @if (!loading() && hasResults()) {
      <!-- Cigars Group (Priority 1) -->
      @if ((searchResults().cigars && searchResults().cigars!.length > 0) || (searchResults().searchType === 'global' && !hasExactCigarMatch())) {
        <ui-search-result-group title="CIGARES" icon="flame">
          <!-- Cigar Results (if any) -->
          @if (searchResults().cigars && searchResults().cigars!.length > 0) {
            @for (cigar of limitedCigars(); track cigar.id) {
              <ui-search-result-item
                [title]="cigar.name"
                [subtitle]="cigar.metadata ?? ''"
                [avatarUrl]="cigar.imageUrl"
                [entityType]="'cigar'"
                [iconBadge]="cigar.isVerified ? 'verified' : 'community'"
                (clicked)="handleResultClick({ id: cigar.id, type: 'cigar', name: cigar.name, subtitle: cigar.metadata ?? '', avatarUrl: cigar.imageUrl ?? undefined })"
              />
            }

            <!-- See All Item -->
            @if (hasMoreCigars()) {
              <div
                class="px-4 py-2 text-xs text-gold-500 hover:text-gold-400 cursor-pointer font-medium border-t border-smoke-700/30 transition-colors"
                (click)="handleSeeAll('cigar')"
              >
                -> Voir tous les cigares ({{ searchResults().cigars!.length }})
              </div>
            }
          }

          <!-- Search-to-Create Action (Global Search Only) -->
          @if (searchResults().searchType === 'global' && !hasExactCigarMatch()) {
            <ui-search-result-item
              [title]="'+ Ajouter ' + searchResults().query + ' a la base'"
              [subtitle]="'Creer un nouveau cigare'"
              [entityType]="'cigar'"
              (clicked)="handleCreateCigar()"
            />
          }
        </ui-search-result-group>
      }

      <!-- Brands Group (Priority 1) -->
      @if (searchResults().brands && searchResults().brands!.length > 0) {
        <ui-search-result-group title="MARQUES" icon="star">
          @for (brand of limitedBrands(); track brand.id) {
            <ui-search-result-item
              [title]="brand.name"
              [subtitle]="brand.metadata ?? brand.country"
              [avatarUrl]="brand.imageUrl"
              [entityType]="'brand'"
              (clicked)="handleResultClick({ id: brand.id, type: 'brand', name: brand.name, subtitle: brand.metadata ?? brand.country, avatarUrl: brand.imageUrl ?? undefined })"
            />
          }

          <!-- See All Item -->
          @if (hasMoreBrands()) {
            <div
              class="px-4 py-2 text-xs text-gold-500 hover:text-gold-400 cursor-pointer font-medium border-t border-smoke-700/30 transition-colors"
              (click)="handleSeeAll('brand')"
            >
              -> Voir toutes les marques ({{ searchResults().brands!.length }})
            </div>
          }
        </ui-search-result-group>
      }

      <!-- Clubs Group (Priority 2) -->
      @if (searchResults().clubs && searchResults().clubs!.length > 0) {
        <ui-search-result-group title="CLUBS" icon="home">
          @for (club of limitedClubs(); track club.id) {
            <ui-search-result-item
              [title]="club.name"
              [subtitle]="'#' + club.slug"
              [iconBadge]="club.visibility === 'PUBLIC' ? 'public' : 'private'"
              [avatarUrl]="club.imageUrl"
              [entityType]="'club'"
              (clicked)="handleResultClick({ id: club.id, type: 'club', name: club.name, subtitle: '#' + club.slug, avatarUrl: club.imageUrl ?? undefined, iconBadge: club.visibility === 'PUBLIC' ? 'public' : 'private' })"
            />
          }

          <!-- See All Item -->
          @if (hasMoreClubs()) {
            <div
              class="px-4 py-2 text-xs text-gold-500 hover:text-gold-400 cursor-pointer font-medium border-t border-smoke-700/30 transition-colors"
              (click)="handleSeeAll('club')"
            >
              -> Voir tous les clubs ({{ searchResults().clubs!.length }})
            </div>
          }
        </ui-search-result-group>
      }

      <!-- Users Group (Priority 3) -->
      @if (searchResults().users && searchResults().users!.length > 0) {
        <ui-search-result-group title="MEMBRES" icon="users">
          @for (user of limitedUsers(); track user.id) {
            <ui-search-result-item
              [title]="user.name"
              [subtitle]="'@' + user.username"
              [avatarUrl]="user.imageUrl"
              [entityType]="'user'"
              (clicked)="handleResultClick({ id: user.id, type: 'user', name: user.name, subtitle: '@' + user.username, avatarUrl: user.imageUrl ?? undefined })"
            />
          }

          <!-- See All Item -->
          @if (hasMoreUsers()) {
            <div
              class="px-4 py-2 text-xs text-gold-500 hover:text-gold-400 cursor-pointer font-medium border-t border-smoke-700/30 transition-colors"
              (click)="handleSeeAll('user')"
            >
              -> Voir tous les membres ({{ searchResults().users!.length }})
            </div>
          }
        </ui-search-result-group>
      }
    }

    <!-- Empty State -->
    @if (showEmpty()) {
      <div class="px-4 py-3 text-center">
        <p class="text-sm text-smoke-400">Aucun resultat trouve</p>
      </div>

      <!-- Create Cigar Option -->
      @if (searchResults().query && searchResults().query.trim().length >= 1) {
        <ui-search-result-group title="CIGARES" icon="flame">
          <ui-search-result-item
            [title]="'+ Ajouter ' + searchResults().query.trim() + ' a la base'"
            [subtitle]="'Creer un nouveau cigare'"
            [entityType]="'cigar'"
            (clicked)="handleCreateCigar()"
          />
        </ui-search-result-group>
      }
    }
    </div>
  </div>

  <!-- Keyboard Hints (Desktop only) -->
  <div class="hidden md:flex items-center gap-2 mt-6 pt-4 border-t border-smoke-700 text-xs text-smoke-500">
    <kbd class="px-2 py-1 bg-smoke-700 rounded text-smoke-300 font-mono">Enter</kbd>
    <span>Selectionner</span>
  </div>
</div>

<!-- Create Cigar Modal -->
<app-create-cigar-modal
  [isOpen]="createCigarModalOpen()"
  [prefillName]="createCigarPrefillName()"
  (close)="createCigarModalOpen.set(false)"
/>