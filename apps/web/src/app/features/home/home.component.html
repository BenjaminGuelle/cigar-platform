<!--
  Layout Structure:
  - Desktop elements (sidebar, top tabs) → position: fixed (outside wrapper)
  - Mobile header → position: fixed (outside wrapper)
  - Mobile tabbar → position: fixed (outside wrapper)
  - Main content → inside vaulDrawerWrapper (scales on modal open)
  - Header/tabbar stay in place, only content scales (avoids transform/fixed issues)
-->

<!-- Desktop Context Sidebar (≥ 768px) - Outside wrapper, stays fixed -->
<app-desktop-sidebar
  [user]="currentUser()"
  [clubs]="userClubs()"
  [activeContextType]="context().type"
  [activeClubId]="context().clubId"
  (contextSelected)="onContextSelected($event)"
  (createJoinClub)="onCreateJoinClub()"
/>

<!-- Desktop Top Tabs (≥ 768px) - Outside wrapper, stays fixed -->
<app-desktop-top-tabs
  [notificationsBadge]="3"
  (notificationsClick)="onNotificationsOpen()"
>
  <app-desktop-top-tab-item
    label="Accueil"
    route="/dashboard"
    icon="home"
    [exact]="true"
  />
  <app-desktop-top-tab-item
    label="Recherche"
    route="/explore"
    icon="search"
  />
  <app-desktop-top-tab-item
    label="Dégustation"
    route="/tastings"
    icon="flame"
  />
  <app-desktop-top-tab-item
    label="Cave"
    [route]="null"
    icon="book-copy"
    (clicked)="onComingSoonOpen('Cave')"
  />
  <app-desktop-top-tab-item
    label="Profil"
    route="/profile"
    icon="user"
  />
  @if (isAdmin()) {
    <app-desktop-top-tab-item
      label="Admin"
      route="/admin"
      icon="lock"
    />
  }
</app-desktop-top-tabs>

<!-- Mobile Header (< 768px) - Fixed, outside wrapper to avoid transform issues -->
@if (!isExplorePage()) {
  <app-mobile-header
    [contextType]="context().type"
    [user]="currentUser()"
    [club]="context().club"
    [notificationsBadge]="3"
    (contextClick)="onContextClick()"
    (notificationsClick)="onNotificationsOpen()"
    (settingsClick)="onSettingsOpen()"
  />
}

<!-- ============================================ -->
<!-- VAUL WRAPPER - Only main content scales -->
<!-- ============================================ -->
<div
  class="min-h-dvh bg-smoke-700 md:min-h-screen"
  appPullToRefresh
  vaulDrawerWrapper
>
  <!-- Main Content Area -->
  <main
    class="px-4 pb-24 md:pb-8 md:pl-18 md:pr-8"
    [class.main-content]="!isExplorePage()"
    [class.main-content-no-header]="isExplorePage()"
  >
    <router-outlet />
  </main>
</div>

<!-- Mobile Tab Bar (< 768px) - Fixed, outside wrapper -->
<app-mobile-tab-bar>
    <app-mobile-tab-item
      icon="home"
      route="/dashboard"
      [exact]="true"
    />
    <app-mobile-tab-item
      icon="search"
      route="/explore"
    />
    <app-mobile-tab-item
      icon="flame"
      [route]="null"
      (clicked)="onFabMenuToggle()"
    />
    <app-mobile-tab-item
      icon="book-copy"
      [route]="null"
      (clicked)="onComingSoonOpen('Cave')"
    />
    <app-mobile-tab-item
      icon="user"
      route="/profile"
    />
    @if (isAdmin()) {
      <app-mobile-tab-item
        icon="lock"
        route="/admin"
      />
    }
</app-mobile-tab-bar>

<!-- FAB Menu - Outside wrapper (rendered via overlay anyway) -->
<ui-fab-menu
  class="[&>button]:hidden md:[&>button]:flex"
  [isOpen]="fabMenuOpen()"
  [items]="fabMenuItems()"
  (toggle)="onFabMenuToggle()"
  (close)="onFabMenuClose()"
  (itemClicked)="onFabMenuItemClick($event)"
/>

<!-- ============================================ -->
<!-- MODALS & DRAWERS - Rendered via CDK Overlay -->
<!-- ============================================ -->

<app-context-switcher
  [isOpen]="contextSwitcherOpen()"
  [user]="currentUser()"
  [clubs]="userClubs()"
  [activeContext]="{ type: context().type, clubId: context().clubId }"
  (close)="onContextSwitcherClose()"
  (contextSelected)="onContextSelected($event)"
  (createClub)="onCreateJoinClub()"
  (joinClub)="onCreateJoinClub()"
/>

<app-create-join-club-modal
  [isOpen]="createJoinClubModalOpen()"
  (close)="onCreateJoinClubModalClose()"
  (clubCreated)="onClubCreated()"
  (clubJoined)="onClubJoined()"
/>

<app-create-content-modal
  [isOpen]="createContentModalOpen()"
  [contextClubName]="context().club?.name || null"
  (close)="onCreateContentModalClose()"
  (eventCreated)="onEventCreated()"
/>

<ui-coming-soon-modal
  [isOpen]="comingSoonModalOpen()"
  [featureName]="comingSoonFeature()"
  (close)="onComingSoonClose()"
/>

<app-notifications-drawer
  [isOpen]="notificationsDrawerOpen()"
  (close)="onNotificationsClose()"
/>

<app-settings-drawer
  [isOpen]="settingsDrawerOpen()"
  (close)="onSettingsClose()"
/>