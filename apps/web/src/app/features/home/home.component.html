<div class="min-h-screen" appPullToRefresh>
  <!-- Mobile Header (< 768px) -->
  <app-mobile-header
    [contextType]="context().type"
    [user]="currentUser()"
    [club]="context().club"
    [notificationsBadge]="3"
    (contextClick)="onContextClick()"
    (notificationsClick)="onNotificationsOpen()"
    (settingsClick)="onSettingsOpen()"
  />

  <!-- Desktop Context Sidebar (≥ 768px) - Left avatar stack -->
  <app-desktop-sidebar
    [user]="currentUser()"
    [clubs]="userClubs()"
    [activeContextType]="context().type"
    [activeClubId]="context().clubId"
    (contextSelected)="onContextSelected($event)"
    (createJoinClub)="onCreateJoinClub()"
  />

  <!-- Desktop Top Tabs (≥ 768px) - Horizontal navigation -->
  <app-desktop-top-tabs
    [notificationsBadge]="3"
    (notificationsClick)="onNotificationsOpen()"
  >
    <!-- 1. Dashboard (contextualisé : Solo = Dashboard perso, Club = Dashboard club) -->
    <app-desktop-top-tab-item
      label="Accueil"
      route="/dashboard"
      icon="home"
      [exact]="true"
    />

    <!-- 2. Search (modal omnisearch) -->
    <app-desktop-top-tab-item
      label="Recherche"
      [route]="null"
      icon="search"
      (clicked)="onSearchOpen()"
    />

    <!-- 3. Tasting (navigation vers liste) -->
    <app-desktop-top-tab-item
      label="Dégustation"
      route="/tastings"
      icon="flame"
    />

    <!-- 4. Cave (prochainement) -->
    <app-desktop-top-tab-item
      label="Cave"
      [route]="null"
      icon="book-copy"
      (clicked)="onComingSoonOpen('Cave')"
    />

    <!-- 5. Profil (contextuel) -->
    <app-desktop-top-tab-item
      label="Profil"
      route="/profile"
      icon="user"
    />

    <!-- 6. Admin (visible si ADMIN/SUPER_ADMIN/MODERATOR) -->
    @if (isAdmin()) {
      <app-desktop-top-tab-item
        label="Admin"
        route="/admin"
        icon="lock"
      />
    }
  </app-desktop-top-tabs>

  <!-- Main Content Area -->
  <main class="min-h-screen overflow-auto scroll-touch px-4 pb-24 pt-20 md:pb-8 md:pl-18 md:pr-8 md:pt-24">
    <router-outlet />
  </main>

  <!-- Context Switcher (Mobile Bottom Sheet) -->
  <app-context-switcher
    [isOpen]="contextSwitcherOpen()"
    [user]="currentUser()"
    [clubs]="userClubs()"
    [activeContext]="{ type: context().type, clubId: context().clubId }"
    (close)="onContextSwitcherClose()"
    (contextSelected)="onContextSelected($event)"
    (createClub)="onCreateJoinClub()"
    (joinClub)="onCreateJoinClub()"
  />

  <app-mobile-tab-bar>
    <!-- 1. Dashboard -->
    <app-mobile-tab-item
      icon="home"
      route="/dashboard"
      [exact]="true"
    />

    <!-- 2. Search -->
    <app-mobile-tab-item
      icon="search"
      [route]="null"
      (clicked)="onSearchOpen()"
    />

    <!-- 3. Create (FAB menu) -->
    <app-mobile-tab-item
      icon="flame"
      [route]="null"
      (clicked)="onFabMenuToggle()"
    />

    <!-- 4. Cave -->
    <app-mobile-tab-item
      icon="book-copy"
      [route]="null"
      (clicked)="onComingSoonOpen('Cave')"
    />

    <!-- 5. Profile -->
    <app-mobile-tab-item
      icon="user"
      route="/profile"
    />

    <!-- 6. Admin -->
    @if (isAdmin()) {
      <app-mobile-tab-item
        icon="lock"
        route="/admin"
      />
    }
  </app-mobile-tab-bar>

  <!-- FAB Menu - Quick Actions (Mobile + Desktop) -->
  <!-- Mobile: Menu items only (button hidden via CSS) -->
  <!-- Desktop: Full FAB with button -->
  <ui-fab-menu
    class="[&>button]:hidden md:[&>button]:flex"
    [isOpen]="fabMenuOpen()"
    [items]="fabMenuItems()"
    (toggle)="onFabMenuToggle()"
    (close)="onFabMenuClose()"
    (itemClicked)="onFabMenuItemClick($event)"
  />

  <!-- Create/Join Club Modal -->
  <app-create-join-club-modal
    [isOpen]="createJoinClubModalOpen()"
    (close)="onCreateJoinClubModalClose()"
    (clubCreated)="onClubCreated()"
    (clubJoined)="onClubJoined()"
  />

  <!-- Create Event Modal -->
  <app-create-content-modal
    [isOpen]="createContentModalOpen()"
    [contextClubName]="context().club?.name || null"
    (close)="onCreateContentModalClose()"
    (eventCreated)="onEventCreated()"
  />

  <!-- Global Search Modal -->
  <app-global-search
    [isOpen]="searchModalOpen()"
    (close)="onSearchClose()"
  />

  <!-- Coming Soon Modal -->
  <ui-coming-soon-modal
    [isOpen]="comingSoonModalOpen()"
    [featureName]="comingSoonFeature()"
    (close)="onComingSoonClose()"
  />

  <!-- Notifications Drawer -->
  <app-notifications-drawer
    [isOpen]="notificationsDrawerOpen()"
    (close)="onNotificationsClose()"
  />

  <!-- Settings Drawer -->
  <app-settings-drawer
    [isOpen]="settingsDrawerOpen()"
    (close)="onSettingsClose()"
  />
</div>