<!--
  AppShell Layout Component
  =========================
  Single source of truth for app layout following ALL STARS architecture.

  Structure:
  - Desktop (≥768px): Sidebar (left) + Top tabs + Content
  - Mobile (<768px): Header + Content + TabBar

  Fixed elements (outside wrapper):
  - Desktop sidebar, top tabs
  - Mobile header, tabbar

  Scalable content (inside vaulDrawerWrapper):
  - Main content area (scales on modal open for Vaul effect)
-->

<!-- Desktop Context Sidebar (≥ 768px) - Fixed position -->
<app-desktop-sidebar
  [user]="currentUser()"
  [clubs]="userClubs()"
  [activeContextType]="context().type"
  [activeClubId]="context().clubId"
  (contextSelected)="onContextSelected($event)"
  (createJoinClub)="onCreateJoinClub()"
/>

<!-- Desktop Top Tabs (≥ 768px) - Fixed position -->
<app-desktop-top-tabs
  [notificationsBadge]="3"
  (notificationsClick)="onNotificationsOpen()"
>
  <app-desktop-top-tab-item
    label="Accueil"
    route="/dashboard"
    icon="home"
    [exact]="true"
  />
  <app-desktop-top-tab-item
    label="Recherche"
    route="/explore"
    icon="search"
  />
  <app-desktop-top-tab-item
    label="Dégustation"
    route="/tasting/new"
    icon="flame"
  />
  <app-desktop-top-tab-item
    label="Cave"
    [route]="null"
    icon="book-copy"
    (clicked)="onComingSoonOpen('Cave')"
  />
  <app-desktop-top-tab-item
    label="Profil"
    route="/profile"
    icon="user"
  />
  @if (isAdmin()) {
    <app-desktop-top-tab-item
      label="Admin"
      route="/admin"
      icon="lock"
    />
  }
</app-desktop-top-tabs>

<!-- Mobile Header (< 768px) -->
@if (isExplorePage()) {
  <app-mobile-header-explore />
} @else {
  <app-mobile-header
    [contextType]="context().type"
    [user]="currentUser()"
    [club]="context().club"
    [notificationsBadge]="0"
    (contextClick)="onContextClick()"
    (notificationsClick)="onNotificationsOpen()"
    (settingsClick)="onSettingsOpen()"
  />
}

<!-- ============================================ -->
<!-- VAUL WRAPPER - Main content with scale effect -->
<!-- ============================================ -->
<div
  class="min-h-dvh bg-smoke-700 md:min-h-screen"
  appPullToRefresh
  vaulDrawerWrapper
>
  <!--
    Main Content Area
    =================
    Structural offsets only (AppShell responsibility):
    - pb-24: mobile tabbar clearance (96px)
    - md:pb-8: desktop bottom spacing (32px)
    - md:pl-18: desktop sidebar offset (72px)

    Content padding handled by pages via container-page-* classes
  -->
  <main class="main-content pb-24 md:pb-8 md:pl-18">
    <ng-content />
  </main>
</div>

<!-- Mobile Tab Bar (< 768px) - Fixed position -->
<app-mobile-tab-bar>
  <app-mobile-tab-item
    icon="home"
    route="/dashboard"
    [exact]="true"
  />
  <app-mobile-tab-item
    icon="search"
    route="/explore"
  />
  <app-mobile-tab-item
    icon="flame"
    [route]="null"
    (clicked)="onFabMenuToggle()"
  />
  <app-mobile-tab-item
    icon="book-copy"
    [route]="null"
    (clicked)="onComingSoonOpen('Cave')"
  />
  <app-mobile-tab-item
    icon="user"
    route="/profile"
  />
  @if (isAdmin()) {
    <app-mobile-tab-item
      icon="lock"
      route="/admin"
    />
  }
</app-mobile-tab-bar>

<!-- FAB Menu - Desktop only visible button, mobile via tabbar -->
<ui-fab-menu
  class="[&>button]:hidden md:[&>button]:flex"
  [isOpen]="fabMenuOpen()"
  [items]="fabMenuItems()"
  (toggle)="onFabMenuToggle()"
  (close)="onFabMenuClose()"
  (itemClicked)="onFabMenuItemClick($event)"
/>

<!-- ============================================ -->
<!-- MODALS & DRAWERS - Rendered via CDK Overlay -->
<!-- ============================================ -->

<!-- Context Switcher (Mobile bottom sheet) -->
<app-context-switcher
  [isOpen]="contextSwitcherOpen()"
  [user]="currentUser()"
  [clubs]="userClubs()"
  [activeContext]="{ type: context().type, clubId: context().clubId }"
  (close)="onContextSwitcherClose()"
  (contextSelected)="onContextSelected($event)"
  (createClub)="onCreateJoinClub()"
  (joinClub)="onCreateJoinClub()"
/>

<!-- Create/Join Club Modal -->
<app-create-join-club-modal
  [isOpen]="createJoinClubModalOpen()"
  (close)="onCreateJoinClubModalClose()"
  (clubCreated)="onClubCreated()"
  (clubJoined)="onClubJoined()"
/>

<!-- Create Content Modal (Events) -->
<app-create-content-modal
  [isOpen]="createContentModalOpen()"
  [contextClubName]="context().club?.name || null"
  (close)="onCreateContentModalClose()"
  (eventCreated)="onEventCreated()"
/>

<!-- Coming Soon Modal -->
<ui-coming-soon-modal
  [isOpen]="comingSoonModalOpen()"
  [featureName]="comingSoonFeature()"
  (close)="onComingSoonClose()"
/>

<!-- Notifications Drawer -->
<app-notifications-drawer
  [isOpen]="notificationsDrawerOpen()"
  (close)="onNotificationsClose()"
/>

<!-- Settings Drawer -->
<app-settings-drawer
  [isOpen]="settingsDrawerOpen()"
  (close)="onSettingsClose()"
/>