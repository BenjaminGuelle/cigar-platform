<div class="space-y-1.5">
  @if (label()) {
    <label
      [for]="autocompleteId()"
      class="block text-sm font-medium text-smoke-100"
    >
      {{ label() }}
      @if (required()) {
        <span class="text-error-500 ml-1">*</span>
      }
    </label>
  }

  <div [class]="CLASSES.container">
    <!-- Input -->
    <input
      [id]="autocompleteId()"
      type="text"
      [class]="inputClasses()"
      [placeholder]="placeholder()"
      [formControl]="control()"
      autocomplete="new-password"
      [attr.aria-describedby]="ariaDescribedBy()"
      [attr.aria-invalid]="showError()"
      [attr.aria-expanded]="isOpen()"
      [attr.aria-autocomplete]="'list'"
      (focus)="onFocus()"
      (input)="onInput($event)"
      (keydown)="handleKeyDown($event)"
    />

    <!-- Dropdown -->
    @if (isOpen()) {
      <div [class]="CLASSES.dropdown.base" role="listbox">
        <!-- Loading State -->
        @if (loading()) {
          <div class="px-4 py-2.5 text-sm text-smoke-400">
            Recherche en cours...
          </div>
        }

        <!-- Options -->
        @if (!loading()) {
          @for (option of options(); track option.value; let i = $index) {
            <div
              role="option"
              [class]="optionClasses(i)"
              (click)="selectOption(option)"
              (mouseenter)="setHighlightedIndex(i)"
            >
              <!-- With Avatar (Logo or fallback initial) -->
              @if (option.logoUrl || option.avatarText) {
                <div class="flex items-center gap-3">
                  <!-- Image if available -->
                  @if (option.logoUrl) {
                    <img
                      [src]="option.logoUrl"
                      [alt]="option.label + ' logo'"
                      [class]="CLASSES.logo.image"
                    />
                  }

                  <!-- Fallback with initial if no image -->
                  @if (!option.logoUrl && option.avatarText) {
                    <div [class]="CLASSES.logo.fallback">
                      <span [class]="CLASSES.logo.fallbackText">{{ option.avatarText }}</span>
                    </div>
                  }

                  <div class="flex-1">
                    <div class="font-medium">{{ option.label }}</div>
                    @if (option.metadata) {
                      <div class="text-xs text-smoke-400">{{ option.metadata }}</div>
                    }
                  </div>
                </div>
              }

              <!-- Without Avatar (Simple: label + metadata right) -->
              @if (!option.logoUrl && !option.avatarText) {
                <div class="flex items-center justify-between gap-3 w-full">
                  <div class="font-medium">{{ option.label }}</div>
                  @if (option.metadata) {
                    <div class="text-2xl">{{ option.metadata }}</div>
                  }
                </div>
              }
            </div>
          }

          <!-- No Results -->
          @if (options().length === 0 && !showCreate()) {
            <div class="px-4 py-2.5 text-sm text-smoke-400">
              Aucun r√©sultat
            </div>
          }

          <!-- Create New Option -->
          @if (showCreate()) {
            <div
              [class]="createOptionClasses()"
              (click)="onCreateNew()"
              (mouseenter)="setHighlightedIndex(options().length)"
            >
              <lucide-icon [img]="Plus" [size]="16" />
              <span>{{ createLabel() }} "{{ searchQuery() }}"</span>
            </div>
          }
        }
      </div>
    }
  </div>

  @if (hint() && !showError()) {
    <p [id]="hintId()" class="text-sm text-smoke-400">
      {{ hint() }}
    </p>
  }

  @if (showError()) {
    <p [id]="errorId()" class="text-sm text-error-500" role="alert">
      {{ errorMessage() }}
    </p>
  }
</div>
