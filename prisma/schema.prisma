// Prisma schema for Cigar Platform
// Database: PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

// Global platform roles
enum Role {
  SUPER_ADMIN  // Platform super admin (full control, accès /admin)
  MODERATOR    // Platform moderator (modération contenu global)
  USER         // Standard user (default)
}

// Club-specific roles
enum ClubRole {
  owner   // Club owner (créateur, droits maximum)
  admin   // Club admin (peut gérer membres, events)
  member  // Club member (peut voir et participer)
}

// Club visibility
enum ClubVisibility {
  PUBLIC   // Visible dans /explore, rejoignable selon autoApprove
  PRIVATE  // Invitation/demande uniquement
}

// User visibility (for profile display)
enum UserVisibility {
  PUBLIC   // displayName visible, @username en sous-titre
  PRIVATE  // Seulement @username visible, displayName masqué
}

// Join request status
enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// ============================================
// MODELS
// ============================================

model User {
  id          String   @id @default(uuid()) @db.Uuid
  email       String   @unique
  displayName String
  username    String   @unique // @username - identité unique (3-30 chars, a-z0-9._)
  avatarUrl   String?
  bio         String?  @db.Text

  // Privacy settings
  visibility               UserVisibility @default(PUBLIC) // PUBLIC: displayName visible | PRIVATE: only @username
  shareEvaluationsPublicly Boolean        @default(true)

  role      Role     @default(USER)
  createdAt DateTime @default(now())

  // Relations
  clubMemberships  ClubMember[]
  createdClubs     Club[]            @relation("CreatedClubs")
  evaluations      Evaluation[]
  createdCigars    Cigar[]           @relation("CreatedCigars")
  createdEvents    Event[]           @relation("CreatedEvents")
  clubJoinRequests ClubJoinRequest[]
  bannedFromClubs  ClubBan[]         @relation("BannedFromClubs")
  bannedMembers    ClubBan[]         @relation("BannedMembers")

  @@index([username])
  @@map("users")
}

model Club {
  id          String   @id @default(uuid()) @db.Uuid
  name        String
  slug        String   @unique // #slug - identité unique du club (3-30 chars, a-z0-9._)
  description String?
  imageUrl    String?
  coverUrl    String?

  // Visibilité et accès
  visibility        ClubVisibility @default(PUBLIC)
  inviteCode        String?        @unique
  isPublicDirectory Boolean        @default(true)

  // Settings de jointure
  autoApproveMembers Boolean @default(true)
  allowMemberInvites Boolean @default(false)
  maxMembers         Int?

  // Status
  isArchived Boolean @default(false)

  // Metadata
  createdBy String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator       User              @relation("CreatedClubs", fields: [createdBy], references: [id], onDelete: Cascade)
  members       ClubMember[]
  events        Event[]
  joinRequests  ClubJoinRequest[]
  bannedMembers ClubBan[]

  @@index([slug])
  @@map("clubs")
}

model ClubMember {
  id       String   @id @default(uuid()) @db.Uuid
  clubId   String   @db.Uuid
  userId   String   @db.Uuid
  role     ClubRole @default(member)
  joinedAt DateTime @default(now())

  // Relations
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@map("club_members")
}

model ClubJoinRequest {
  id        String            @id @default(uuid()) @db.Uuid
  clubId    String            @db.Uuid
  userId    String            @db.Uuid
  status    JoinRequestStatus @default(PENDING)
  message   String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relations
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
  @@map("club_join_requests")
}

model ClubBan {
  id        String   @id @default(uuid()) @db.Uuid
  clubId    String   @db.Uuid
  userId    String   @db.Uuid
  bannedBy  String   @db.Uuid
  reason    String?
  createdAt DateTime @default(now())

  // Relations
  club         Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user         User @relation("BannedFromClubs", fields: [userId], references: [id], onDelete: Cascade)
  bannedByUser User @relation("BannedMembers", fields: [bannedBy], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
  @@map("club_bans")
}

model Event {
  id          String   @id @default(uuid()) @db.Uuid
  clubId      String   @db.Uuid
  cigarId     String?  @db.Uuid
  name        String
  description String?
  date        DateTime
  createdBy   String   @db.Uuid
  createdAt   DateTime @default(now())

  // Relations
  club        Club         @relation(fields: [clubId], references: [id], onDelete: Cascade)
  cigar       Cigar?       @relation(fields: [cigarId], references: [id], onDelete: SetNull)
  creator     User         @relation("CreatedEvents", fields: [createdBy], references: [id], onDelete: Cascade)
  evaluations Evaluation[]

  @@index([clubId])
  @@map("events")
}

model Cigar {
  id        String   @id @default(uuid()) @db.Uuid
  brand     String
  name      String
  origin    String?
  wrapper   String?
  createdBy String   @db.Uuid
  createdAt DateTime @default(now())

  // Relations
  creator     User         @relation("CreatedCigars", fields: [createdBy], references: [id], onDelete: Cascade)
  evaluations Evaluation[]
  events      Event[]

  @@unique([brand, name])
  @@index([brand, name])
  @@map("cigars")
}

model Evaluation {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  cigarId   String   @db.Uuid
  eventId   String?  @db.Uuid
  rating    Int // 1-5
  photoUrl  String?
  date      DateTime
  duration  Int? // minutes
  comment   String?  @db.Text
  createdAt DateTime @default(now())

  // Présentation (avant allumage)
  capeAspects String[] // Multi-select: ['tight', 'oily', ...]
  capeColor   String? // Single select
  touch       String? // Single select

  // Tirage à cru
  coldTastes String[] // Multi-select
  coldAromas String[] // Multi-select
  coldNotes  String?  @db.Text

  // 1er tiers
  firstTastes   String[] // Multi-select
  firstAromas   String[] // Multi-select
  firstStrength Int? // 1-5
  firstNotes    String?  @db.Text

  // 2e tiers
  secondTastes   String[] // Multi-select
  secondAromas   String[] // Multi-select
  secondStrength Int? // 1-5
  secondNotes    String?  @db.Text

  // 3e tiers
  thirdTastes   String[] // Multi-select
  thirdAromas   String[] // Multi-select
  thirdStrength Int? // 1-5
  thirdNotes    String?  @db.Text

  // Bilan global
  startImpressions String[] // Multi-select
  finalImpressions String[] // Multi-select
  persistence      String? // Single select
  draw             String? // Single select
  terroir          String? // Single select
  balance          String? // Single select
  moment           String? // Single select
  ashNature        String? // Single select
  situation        String? // Single select

  // Relations
  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  cigar Cigar  @relation(fields: [cigarId], references: [id], onDelete: Cascade)
  event Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([eventId])
  @@index([cigarId])
  @@map("evaluations")
}
