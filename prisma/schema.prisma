// Prisma schema for Cigar Platform
// Database: PostgreSQL via Supabase

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// ENUMS
// ============================================

// Global platform roles
enum Role {
  SUPER_ADMIN // Platform super admin (full control, accès /admin)
  MODERATOR // Platform moderator (modération contenu global)
  USER // Standard user (default)
}

// Club-specific roles
enum ClubRole {
  owner // Club owner (créateur, droits maximum)
  admin // Club admin (peut gérer membres, events)
  member // Club member (peut voir et participer)
}

// Club visibility
enum ClubVisibility {
  PUBLIC // Visible dans /explore, rejoignable selon autoApprove
  PRIVATE // Invitation/demande uniquement
}

// User visibility (for profile display)
enum UserVisibility {
  PUBLIC // displayName visible, @username en sous-titre
  PRIVATE // Seulement @username visible, displayName masqué
}

// Join request status
enum JoinRequestStatus {
  PENDING
  APPROVED
  REJECTED
}

// Cigar verification status
enum CigarStatus {
  PENDING // En attente de validation (user-submitted)
  VERIFIED // Validé par un modérateur
  REJECTED // Rejeté (doublon, erreur)
}

// Tasting visibility
enum TastingVisibility {
  PUBLIC // Visible par tous
  PRIVATE // Visible uniquement par l'auteur
  CLUB_ONLY // Visible uniquement par les membres des clubs partagés
}

// ============================================
// MODELS
// ============================================

model User {
  id          String  @id @default(uuid()) @db.Uuid
  email       String  @unique
  displayName String
  username    String  @unique // @username - identité unique (3-30 chars, a-z0-9._)
  avatarUrl   String?
  bio         String? @db.Text

  // Privacy settings
  visibility               UserVisibility @default(PUBLIC) // PUBLIC: displayName visible | PRIVATE: only @username
  shareEvaluationsPublicly Boolean        @default(true)

  role      Role     @default(USER)
  createdAt DateTime @default(now())

  // Relations
  clubMemberships  ClubMember[]
  createdClubs     Club[]            @relation("CreatedClubs")
  tastings         Tasting[]
  createdBrands    Brand[]           @relation("CreatedBrands")
  createdCigars    Cigar[]           @relation("CreatedCigars")
  createdEvents    Event[]           @relation("CreatedEvents")
  clubJoinRequests ClubJoinRequest[]
  bannedFromClubs  ClubBan[]         @relation("BannedFromClubs")
  bannedMembers    ClubBan[]         @relation("BannedMembers")
  verifiedCigars   Cigar[]           @relation("VerifiedCigars")

  @@index([username])
  @@map("users")
}

model Club {
  id          String  @id @default(uuid()) @db.Uuid
  name        String
  slug        String  @unique // #slug - identité unique du club (3-30 chars, a-z0-9._)
  description String?
  imageUrl    String?
  coverUrl    String?

  // Visibilité et accès
  visibility        ClubVisibility @default(PUBLIC)
  inviteCode        String?        @unique
  isPublicDirectory Boolean        @default(true)

  // Settings de jointure
  autoApproveMembers Boolean @default(true)
  allowMemberInvites Boolean @default(false)
  maxMembers         Int?

  // Status
  isArchived Boolean @default(false)

  // Metadata
  createdBy String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  creator       User              @relation("CreatedClubs", fields: [createdBy], references: [id], onDelete: Cascade)
  members       ClubMember[]
  events        Event[]
  joinRequests  ClubJoinRequest[]
  bannedMembers ClubBan[]
  tastings      TastingOnClub[]

  @@index([slug])
  @@map("clubs")
}

model ClubMember {
  id       String   @id @default(uuid()) @db.Uuid
  clubId   String   @db.Uuid
  userId   String   @db.Uuid
  role     ClubRole @default(member)
  joinedAt DateTime @default(now())

  // Relations
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([userId])
  @@index([clubId])
  @@map("club_members")
}

model ClubJoinRequest {
  id        String            @id @default(uuid()) @db.Uuid
  clubId    String            @db.Uuid
  userId    String            @db.Uuid
  status    JoinRequestStatus @default(PENDING)
  message   String?
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relations
  club Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
  @@map("club_join_requests")
}

model ClubBan {
  id        String   @id @default(uuid()) @db.Uuid
  clubId    String   @db.Uuid
  userId    String   @db.Uuid
  bannedBy  String   @db.Uuid
  reason    String?
  createdAt DateTime @default(now())

  // Relations
  club         Club @relation(fields: [clubId], references: [id], onDelete: Cascade)
  user         User @relation("BannedFromClubs", fields: [userId], references: [id], onDelete: Cascade)
  bannedByUser User @relation("BannedMembers", fields: [bannedBy], references: [id], onDelete: Cascade)

  @@unique([clubId, userId])
  @@index([clubId])
  @@index([userId])
  @@map("club_bans")
}

model Event {
  id          String   @id @default(uuid()) @db.Uuid
  clubId      String   @db.Uuid
  cigarId     String?  @db.Uuid
  name        String
  description String?
  date        DateTime
  createdBy   String   @db.Uuid
  createdAt   DateTime @default(now())

  // Relations
  club     Club      @relation(fields: [clubId], references: [id], onDelete: Cascade)
  cigar    Cigar?    @relation(fields: [cigarId], references: [id], onDelete: SetNull)
  creator  User      @relation("CreatedEvents", fields: [createdBy], references: [id], onDelete: Cascade)
  tastings Tasting[]

  @@index([clubId])
  @@map("events")
}

model Brand {
  id          String   @id @default(uuid()) @db.Uuid
  name        String   @unique
  slug        String   @unique // URL-friendly identifier
  logoUrl     String? // SVG logo (Gold for premium brands)
  country     String? // Country of origin
  description String?  @db.Text
  createdBy   String   @db.Uuid
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  creator User    @relation("CreatedBrands", fields: [createdBy], references: [id], onDelete: Cascade)
  cigars  Cigar[]

  @@index([slug])
  @@index([name])
  @@map("brands")
}

model Cigar {
  id      String @id @default(uuid()) @db.Uuid
  brandId String @db.Uuid
  name    String
  slug    String @unique // URL-friendly identifier (brand-name)

  // Technical specifications
  vitola    String? // Format (Robusto, Toro, Churchill, etc.)
  length    Float? // Length in mm
  ringGauge Int? // Ring gauge (diameter in 64ths of an inch)
  wrapper   String? // Wrapper type
  origin    String? // Country of origin
  strength  Int? // 1-5 (light to full)

  // Verification workflow
  status          CigarStatus @default(PENDING)
  isVerified      Boolean     @default(false)
  verifiedBy      String?     @db.Uuid
  verifiedAt      DateTime?
  rejectionReason String?     @db.Text

  // Metadata
  createdBy String   @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  brand    Brand     @relation(fields: [brandId], references: [id], onDelete: Cascade)
  creator  User      @relation("CreatedCigars", fields: [createdBy], references: [id], onDelete: Cascade)
  verifier User?     @relation("VerifiedCigars", fields: [verifiedBy], references: [id], onDelete: SetNull)
  tastings Tasting[]
  events   Event[]

  @@unique([brandId, name])
  @@index([slug])
  @@index([brandId])
  @@index([status])
  @@map("cigars")
}

model Tasting {
  id      String  @id @default(uuid()) @db.Uuid
  userId  String  @db.Uuid
  cigarId String  @db.Uuid
  eventId String? @db.Uuid

  // Core evaluation
  rating   Float // 1-5 (allows decimals like 3.5)
  pleasure Int // 1-10 (plaisir ressenti)

  // Metadata
  photoUrl String? // Photo principale de la dégustation
  date     DateTime
  duration Int? // Durée en minutes
  comment  String?  @db.Text // Commentaire global

  // Privacy
  visibility TastingVisibility @default(PUBLIC)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user         User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  cigar        Cigar           @relation(fields: [cigarId], references: [id], onDelete: Cascade)
  event        Event?          @relation(fields: [eventId], references: [id], onDelete: SetNull)
  observations Observation[] // Multiple observations (1 par phase: début/milieu/fin)
  sharedClubs  TastingOnClub[] // Clubs où la dégustation est partagée

  @@index([userId])
  @@index([cigarId])
  @@index([eventId])
  @@index([visibility])
  @@map("tastings")
}

model Observation {
  id        String @id @default(uuid()) @db.Uuid
  tastingId String @db.Uuid

  // Phase (pour le Tercio - 3 tiers du cigare)
  phase String // 'début' | 'milieu' | 'fin' | 'cru' (tirage à cru)

  // Mesures objectives (1-5)
  intensity  Int? // Intensité des arômes (1-5)
  combustion Int? // Qualité de combustion (1-5)

  // Arômes détectés (simple array pour MVP)
  aromas String[] // ['bois', 'café', 'cuir', 'épices', ...]

  // Notes libres
  notes String? @db.Text

  // Profil organoleptique (JSON pour flexibilité)
  // Contient les données détaillées de la fiche papier (57 champs)
  // Structure: { tastes: [], presentation: {}, draw: {}, balance: {}, etc. }
  organoleptique Json?

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  tasting Tasting @relation(fields: [tastingId], references: [id], onDelete: Cascade)

  @@index([tastingId])
  @@index([phase])
  @@map("observations")
}

model TastingOnClub {
  id        String   @id @default(uuid()) @db.Uuid
  tastingId String   @db.Uuid
  clubId    String   @db.Uuid
  sharedAt  DateTime @default(now())

  // Relations
  tasting Tasting @relation(fields: [tastingId], references: [id], onDelete: Cascade)
  club    Club    @relation(fields: [clubId], references: [id], onDelete: Cascade)

  @@unique([tastingId, clubId])
  @@index([tastingId])
  @@index([clubId])
  @@map("tasting_on_club")
}
